package ru.exmpl.rbdg.generators.impl

import ru.exmpl.rbdg.generators.Generator
import ru.exmpl.rbdg.generators.GeneratorResult
import ru.exmpl.rbdg.generators.GeneratorResultWithEscape
import ru.exmpl.rbdg.generators.impl.OktmoGenerator.randomOktmo11
import ru.exmpl.rbdg.generators.impl.OktmoGenerator.randomOktmo8
import kotlin.random.Random

/**
 * Общероссийский классификатор территорий муниципальных образований (ОКТМО).
 *
 * ОКТМО будет состоять из 8 цифр.
 *
 * Код ОКТМО состоит из 8 или 11 цифр, в зависимости от уровня классификации:
 * - *Первые 2 цифры – субъект РФ (республика, край, область, город федерального значения).*
 * - *Следующие 3 цифры (3–5 позиции) – район, город областного подчинения.*
 * - *Последние 3 цифры (6–8 позиции) – город, посёлок, сельсовет и т. д.*
 * - *Дополнительные 3 цифры (9–11 позиции, если есть) – населённый пункт, микрорайон.*
 *
 * **See Also:**
 * [Общероссийский классификатор территорий муниципальных образований (сокр. ОКТМО)](https://ru.wikipedia.org/wiki/%D0%9E%D0%B1%D1%89%D0%B5%D1%80%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%B8%D0%B9_%D0%BA%D0%BB%D0%B0%D1%81%D1%81%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%82%D0%BE%D1%80_%D1%82%D0%B5%D1%80%D1%80%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%B9_%D0%BC%D1%83%D0%BD%D0%B8%D1%86%D0%B8%D0%BF%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D1%85_%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B9)
 *
 * @author Dmitry_Emelyanenko
 */
class Oktmo8Generator : Generator<String> {
  override fun generate(): GeneratorResult<String> = GeneratorResultWithEscape(data = randomOktmo8())
}

/**
 * Общероссийский классификатор территорий муниципальных образований (ОКТМО).
 *
 * ОКТМО будет состоять из 11 цифр.
 *
 * Код ОКТМО состоит из 8 или 11 цифр, в зависимости от уровня классификации:
 * - *Первые 2 цифры – субъект РФ (республика, край, область, город федерального значения).*
 * - *Следующие 3 цифры (3–5 позиции) – район, город областного подчинения.*
 * - *Последние 3 цифры (6–8 позиции) – город, посёлок, сельсовет и т. д.*
 * - *Дополнительные 3 цифры (9–11 позиции, если есть) – населённый пункт, микрорайон.*
 *
 * **See Also:**
 * [Общероссийский классификатор территорий муниципальных образований (сокр. ОКТМО)](https://ru.wikipedia.org/wiki/%D0%9E%D0%B1%D1%89%D0%B5%D1%80%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%B8%D0%B9_%D0%BA%D0%BB%D0%B0%D1%81%D1%81%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%82%D0%BE%D1%80_%D1%82%D0%B5%D1%80%D1%80%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%B9_%D0%BC%D1%83%D0%BD%D0%B8%D1%86%D0%B8%D0%BF%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D1%85_%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B9)
 *
 * @author Dmitry_Emelyanenko
 */
class Oktmo11Generator : Generator<String> {
  override fun generate(): GeneratorResult<String> = GeneratorResultWithEscape(data = randomOktmo11())
}

/**
 * Общероссийский классификатор территорий муниципальных образований (ОКТМО).
 *
 * Код ОКТМО состоит из 8 или 11 цифр, в зависимости от уровня классификации:
 * - *Первые 2 цифры – субъект РФ (республика, край, область, город федерального значения).*
 * - *Следующие 3 цифры (3–5 позиции) – район, город областного подчинения.*
 * - *Последние 3 цифры (6–8 позиции) – город, посёлок, сельсовет и т. д.*
 * - *Дополнительные 3 цифры (9–11 позиции, если есть) – населённый пункт, микрорайон.*
 *
 * **See Also:**
 * [Общероссийский классификатор территорий муниципальных образований (сокр. ОКТМО)](https://ru.wikipedia.org/wiki/%D0%9E%D0%B1%D1%89%D0%B5%D1%80%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%B8%D0%B9_%D0%BA%D0%BB%D0%B0%D1%81%D1%81%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%82%D0%BE%D1%80_%D1%82%D0%B5%D1%80%D1%80%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%B9_%D0%BC%D1%83%D0%BD%D0%B8%D1%86%D0%B8%D0%BF%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D1%85_%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B9)
 *
 * @author Dmitry_Emelyanenko
 */
private object OktmoGenerator {

  fun randomOktmo8(): String = findOKTMO(null, false) ?: ""

  fun randomOktmo11(): String = findOKTMO(null, true) ?: ""

  // База данных ОКТМО: 50 городов с 8-значными кодами и 50 - с 11-значными
  private val OKTMO_DATABASE = mapOf(
    // 8-значные коды (50 городов)
    "Москва" to "45300000",
    "Санкт-Петербург" to "40300000",
    "Новосибирск" to "50401000",
    "Екатеринбург" to "65401000",
    "Казань" to "92401000",
    "Нижний Новгород" to "22401000",
    "Челябинск" to "75401000",
    "Самара" to "36401000",
    "Омск" to "52401000",
    "Ростов-на-Дону" to "60401000",
    "Уфа" to "80401000",
    "Красноярск" to "04401000",
    "Пермь" to "57401000",
    "Воронеж" to "20401000",
    "Волгоград" to "18401000",
    "Краснодар" to "03401000",
    "Саратов" to "63401000",
    "Тюмень" to "71401000",
    "Тольятти" to "36405000",
    "Ижевск" to "94401000",
    "Барнаул" to "01401000",
    "Ульяновск" to "73401000",
    "Иркутск" to "25401000",
    "Хабаровск" to "08401000",
    "Ярославль" to "78401000",
    "Владивосток" to "05401000",
    "Махачкала" to "82401000",
    "Томск" to "69401000",
    "Оренбург" to "53401000",
    "Кемерово" to "32401000",
    "Новокузнецк" to "32404000",
    "Рязань" to "61401000",
    "Астрахань" to "12401000",
    "Набережные Челны" to "92403000",
    "Пенза" to "56401000",
    "Липецк" to "42401000",
    "Киров" to "33401000",
    "Чебоксары" to "97401000",
    "Тула" to "70401000",
    "Калининград" to "27401000",
    "Балашиха" to "45404000",
    "Курск" to "38401000",
    "Ставрополь" to "07401000",
    "Улан-Удэ" to "81401000",
    "Сочи" to "03426000",
    "Магнитогорск" to "75438000",
    "Тверь" to "28401000",
    "Севастополь" to "67300000",
    "Иваново" to "24401000",
    "Брянск" to "15401000",

    // 11-значные коды (50 населённых пунктов)
    "Москва (Тёплый Стан)" to "45397000000",
    "Санкт-Петербург (Парголово)" to "40397000000",
    "Новосибирск (Академгородок)" to "50401389000",
    "Екатеринбург (Уралмаш)" to "65401789000",
    "Казань (Дербышки)" to "92401392000",
    "Нижний Новгород (Сормово)" to "22401345000",
    "Челябинск (Металлургический)" to "75401367000",
    "Самара (Безымянка)" to "36401378000",
    "Омск (Нефтяники)" to "52401356000",
    "Ростов-на-Дону (Северный)" to "60401345000",
    "Уфа (Черниковка)" to "80401367000",
    "Красноярск (Солнечный)" to "04401345000",
    "Пермь (Гайва)" to "57401378000",
    "Воронеж (Левобережный)" to "20401356000",
    "Волгоград (Краснооктябрьский)" to "18401367000",
    "Краснодар (Гидростроителей)" to "03401345000",
    "Саратов (Заводской)" to "63401356000",
    "Тюмень (Мыс)" to "71401378000",
    "Тольятти (Автозаводский)" to "36405345000",
    "Ижевск (Автозаводский)" to "94401367000",
    "Барнаул (Ленинский)" to "01401345000",
    "Ульяновск (Заволжский)" to "73401356000",
    "Иркутск (Свердловский)" to "25401378000",
    "Хабаровск (Индустриальный)" to "08401345000",
    "Ярославль (Фрунзенский)" to "78401356000",
    "Владивосток (Первореченский)" to "05401378000",
    "Махачкала (Советский)" to "82401345000",
    "Томск (Кировский)" to "69401356000",
    "Оренбург (Промышленный)" to "53401378000",
    "Кемерово (Рудничный)" to "32401345000",
    "Новокузнецк (Куйбышевский)" to "32404356000",
    "Рязань (Дягилево)" to "61401365000",
    "Астрахань (Трусовский)" to "12401378000",
    "Набережные Челны (ГЭС)" to "92403345000",
    "Пенза (Октябрьский)" to "56401356000",
    "Липецк (Правобережный)" to "42401378000",
    "Киров (Ленинский)" to "33401345000",
    "Чебоксары (Калининский)" to "97401356000",
    "Тула (Пролетарский)" to "70401378000",
    "Калининград (Ленинградский)" to "27401345000",
    "Балашиха (Железнодорожный)" to "45404356000",
    "Курск (Сеймский)" to "38401378000",
    "Ставрополь (Промышленный)" to "07401345000",
    "Улан-Удэ (Советский)" to "81401356000",
    "Сочи (Адлер)" to "03426355000",
    "Магнитогорск (Правобережный)" to "75438345000",
    "Тверь (Московский)" to "28401356000",
    "Севастополь (Ленинский)" to "67300345000",
    "Иваново (Фрунзенский)" to "24401356000",
    "Брянск (Бежицкий)" to "15401378000"
  )

  /**
   * Поиск ОКТМО по названию города или случайный выбор.
   *
   * @param cityName Название города (регистр не важен). Если null, выбирается случайный город.
   * @param fullCode Если true, возвращает 11-значный код; если false — 8-значный; если null — случайный выбор (50/50).
   * @return Код ОКТМО или null, если город не найден (или база пуста).
   */
  private fun findOKTMO(@Suppress("SameParameterValue") cityName: String? = null, fullCode: Boolean? = null): String? {
    return when {
      // Если город указан, ищем его в базе
      cityName != null -> {
        val targetLength = when (fullCode) {
          true -> 11
          false -> 8
          null -> if (Random.nextBoolean()) 11 else 8
        }
        OKTMO_DATABASE.entries
          .filter { it.value.length == targetLength }
          .find { it.key.equals(cityName, ignoreCase = true) }
          ?.value
      }

      OKTMO_DATABASE.isEmpty() -> null

      else -> {
        val targetLength = when (fullCode) {
          true -> 11
          false -> 8
          null -> if (Random.nextBoolean()) 11 else 8
        }
        val filteredEntries = OKTMO_DATABASE.filterValues { it.length == targetLength }

        if (Random.nextDouble() < 0.7) {
          if (targetLength == 8) {
            filteredEntries["Рязань"] ?: filteredEntries.values.random()
          } else {
            filteredEntries["Рязань (Дягилево)"] ?: filteredEntries.values.random()
          }
        } else {
          filteredEntries.values.random()
        }
      }
    }
  }
}
